<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href='https://fonts.googleapis.com/css?family=IBM Plex Sans Condensed' rel='stylesheet'>
    <title>Main Menu</title>
    <style>
        body {
            font-family: 'IBM Plex Sans Condensed', sans-serif;
            background-color: #FFFFFF;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            overflow-y: auto;
        }

        .container {
            text-align: center;
            width: 75vw;
            max-width: 400px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding-bottom: 100px;
            overflow-y: auto;
        }

        .small-logo {
            width: 10vw;
            height: auto;
        }

        h2 {
            font-size: 1.2rem;
            color: #7A2C2E;
            margin-bottom: 5px;
            margin-top: 5px;
        }

        .menu-card {
        background-color: #F9F9F9;
        border-radius: 15px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        padding: 15px;
        margin-bottom: 20px;
        text-align: left;
        width: calc(100% - 30px);
        margin: 10px auto;
        }

        .menu-card img {
            width: 100%;
            border-radius: 10px;
            margin-bottom: 10px;
            object-fit: cover;
            padding-left: -10vw;
        
        } 
        .menu-card .title {
            font-size: 1.1rem;
            color: #7A2C2E;
            margin: 10px 0;
        }

        .menu-card .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-right: 5px;
        }

        .menu-card .badge-popular {
            background-color: #F1E1C6;
            color: #7A2C2E;
        }

        .menu-card .badge-spicy {
            background-color: #F7E6E7;
            color: #7A2C2E;
        }

        .menu-card .allergens {
            font-size: 0.8rem;
            color: #7A2C2E;
            margin: 10px 0;
        }

        .menu-card .set-menu {
            font-size: 0.8rem;
            color: #7A2C2E;
            margin: 10px 0;
        }

        .menu-card .price {
            font-size: 1.2rem;
            color: #7A2C2E;
            margin: 10px 0;
        }

        .menu-card .add-to-cart-button {
            
            font-size: 1rem;
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background-color: #7A2C2E;
            color: #FFFFFF;
            cursor: pointer;
            transition: background-color 0.3s;
            display: block;
            width: 100%;
            box-sizing: border-box;
        }

        .menu-card .add-to-cart.disabled {
            background-color: #BEB9B7;
            cursor: not-allowed;
        }
        .menu-card .add-to-cart-button:hover {
            background-color: #5A1D1F;
        }

        .skip-link {
            font-size: 0.8em;
            color: #7A2C2E;
            margin-top: 20px;
        }

        .skip-link a {
            text-decoration: none;
            color: #7A2C2E;
            font-weight:700;
            font-size: medium;
        }

        .skip-link a:hover {
            text-decoration: underline;
        }

        .category-tabs {
            display: flex;
            justify-content: start;
            padding-bottom: 5px;
            
            overflow-x: auto;
            gap:10px;
            
        }

        .category-tabs .tab {
            padding: 10px 20px;
            cursor: pointer;
            color: #d2d2d2;
            font-size: 0.9rem;
            transition: background-color 0.3s;
            min-width: 60px;
            flex-shrink: 0;
        }
        .category-tabs ::-webkit-scrollbar{
            display:auto;

        }

        .category-tabs .tab.active {
            font-weight:600;
            color: #ab1010;
        }

        .menu-cards {
            display: flex;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 60px; /* Add bottom padding to prevent overlap */
            gap: 20px; /* Ensure consistent gap */
            padding-left: 2vw;
            

        }
        .menu-cards::-webkit-scrollbar {
            display: auto;
        }
        .card-link {
            text-decoration: none;
            color: inherit;
        }

        .card {
            background-color: #F9F9F9;
            border-radius: 15px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 35px;
            margin: -1vw;
            width: 55vw;
            height: 50vh;
            padding-bottom: 50px;

        }

        .card img {
            width: 236px;
            height: 157px;
            border-radius: 20px;
            margin-bottom: 10px;
            object-fit: scale-down;
            
        }
        img.dish-image {
            width: 236px;
            height: 157px;
            border-radius: 20px;
            margin-bottom: 10px;
            object-fit: scale-down;
        margin-left: -1.5vw;
        }
        .card .dish-name {
            font-size: 1.1em;
            color: #7A2C2E;
            margin: 10px 0;
        }

        .card .tags {
            margin-bottom: 10px;
        }

        .card .tag {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            
        }

        .card .tag.best.seller {
            background-color: #e9bf78;
            color: #090101;
        }

        .card .tag.non-spicy {
            background-color: #fbecec;
            color: #030000;
        }
        .card .tag.little.spicy {
            background-color: #fbbabf;
            color: #ce252b;
        }
        .card .tag.spicy {
            background-color: #eb4b55;
            color: #f6e8e8;
        }
        .card .tag.very.spicy {
            background-color: #ee1423;
            color: #f4d0d1;
        }
        .card .tag.sweet {
            background-color: #a86217;
            color: #fff9f4;
        }
        .card .tag.cold {
            background-color: #b0d8f7;
            color: #00100d;
        }
        .card .tag.vegetarian {
            background-color: #aaf3a9;
            color: #000000;
        }
        .card .tag.pork {
            background-color: #F7E6E7;
            color: #140001;
        }
        .card .tag.beef {
            background-color: #F7E6E7;
            color: #140001;
        }
        .card .tag.chicken {
            background-color: #F7E6E7;
            color: #140001;
        }

        .card .tag.seafood{
            background-color: #a3afe7;
            color: #fbfdfe;
        }
        .card .tag.black.bean {
            background-color: #702d0d;
            color: #f5ece6;
        }
        .card .tag.child.friendly {
            background-color: #f2f20c;
            color: #000000;
        }
        .card .tag.rice{
            background-color: #f7f7ef;
            color: #000000;
        }
        .card .tag.fried {
            background-color: #f6f1bb;
            color: #140001;
        }
        .card .tag.boiled {
            background-color: #d3ecf2;
            color: #140001;
        }
        .card .tag.refillable {
            background-color: #d3ecf2;
            color: #140001;
        }
        .card .allergens {
            font-size: 0.8em;
            color: #7A2C2E;
            margin: 10px 0;
        }
        .description {
            margin-top: 10px;
            font-size: 1em;
            line-height: 1.5;
            color: #555;
        }

        .container.d {
            text-align: center;
            width: 75vw;
            max-width: 400px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding-bottom: 100px;
            overflow-y:auto;
            padding-left: 3vw;
        }
        .options-container {
            display: flex;
            flex-wrap:wrap;  /* Allow items to wrap to the next line */
            justify-content: center;
            gap: 10px;  /* Space between buttons */
            margin-top: 5px;
            margin-bottom:5px;
        }

        .option-button {
            padding: 5px 10px;
            border-radius: 20px;
            border: 1px solid #ccc;
            background-color: #F9F9F9;
            font-size: 0.7rem;
            font-family: 'IBM Plex Sans Condensed', sans-serif;
            color: #7A2C2E;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
            flex: 1 1 45%;  /* Make each button occupy up to 45% of the row */
            max-width: 120px;  /* Maximum width for each button */
            box-sizing: border-box;  /* Include padding and border in width */
            text-align: center;  /* Center text inside button */
            height: 5vh;
            word-wrap:inherit;
            
        }

        .option-button:hover {
            background-color: #EDEDED;
        }

        .option-button.selected {
            background-color: #7A2C2E;
            color: #FFFFFF;
            border-color: #7A2C2E;
        }

        .card .price-add {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card .price {
            font-size: 1.2em;
            color: #7A2C2E;
        }

        .card .add-to-cart {
            font-size: 1em;
            font-family: 'IBM Plex Sans Condensed', sans-serif;
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background-color: #7A2C2E;
            color: #FFFFFF;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .card .add-to-cart:hover {
            background-color: #5A1D1F;
        }
        .back-button {
            position: absolute; /* Absolute positioning */
            top: 10vh;          /* Position from the top */
            left: 12vw;         /* Position from the left */
            font-size: 15px;    /* Larger font size */
            color: #ffffff;     /* Text color */
            background-color: #C49970; /* Background color */
            /* No border */
            border-radius: 5px; /* Rounded corners */
            padding: 5px; /* Padding for size */
            cursor: pointer;    /* Pointer cursor on hover */
            text-align: center; /* Center the text */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Shadow for depth */
            transition: all 0.3s ease; /* Smooth transition */
        }

        .proceed-to-order-button {
            font-size: 1em;
            padding: 15px;
            border: none;
            border-radius: 20px;
            background-color: #7A2C2E;
            color: #FFFFFF;
            cursor: pointer;
            transition: background-color 0.3s;
        
            bottom: 5px;
            left: 50%;
        
            width: calc(80% - 40px); /* Reduce width for better alignment */
            max-width: 800px;
            /* Ensure it's on top of other elements */
        }

        .proceed-to-order-button.disabled {
            background-color: #BEB9B7;
            cursor: not-allowed;
        }

        .proceed-to-order-button.enabled:hover {
            background-color: #5A1D1F;
        }

        .cart-count {
            background-color: #FFFFFF;
            color: #7A2C2E;
            padding: 5px 10px;
            border-radius: 50%;
            margin-left: 10px;
        }   
    </style>
</head>
<body>
    <div class="container">
        <img src="moim_logo.png" alt="Restaurant Logo" class="small-logo">
        <div id="tableNumber" class="tableNumber"></div>
        <h2>Menu</h2>
        <div id="categoryTabs" class="category-tabs"></div>
        <div id="menuCards" class="menu-cards"></div>
        <button id="proceedToOrderButton" class="proceed-to-order-button disabled" onclick="proceedToOrder()" disabled>
            Proceed to Order <span class="cart-count">0</span>
        </button>
    </div>
    <script>
        let cart = [];
        let currentCategory = '구이 Grilled';

        // Load menu data and preload images
        function loadMenuDataAndImages() {
            fetch('menu.json')
                .then(response => response.json())
                .then(data => {
                    loadCategories(data);
                    loadMenuCards(data, currentCategory);
                })
                .catch(error => console.error('Error loading menu data:', error));
        }

        document.addEventListener('DOMContentLoaded', () => {
            const restaurantId = new URLSearchParams(window.location.search).get('restaurantId') || sessionStorage.getItem('restaurantId');
            sessionStorage.setItem('restaurantId', restaurantId);

            const tableNumber = sessionStorage.getItem('tableNumber');
            if (document.getElementById('tableNumber')) {
                document.getElementById('tableNumber').textContent = `Table No: ${tableNumber}`;
            }

            const storedCart = sessionStorage.getItem('cart');
            if (storedCart) {
                cart = JSON.parse(storedCart);
            } else {
                cart = [];
            }
            updateCartButton();
            loadMenuDataAndImages();
        });

        // Load categories
        function loadCategories(data) {
            const categoryTabs = document.getElementById('categoryTabs');
            if (categoryTabs) {
                categoryTabs.innerHTML = '';
                data.forEach(category => {
                    const tab = document.createElement('div');
                    tab.className = 'tab';
                    tab.textContent = category.category;
                    tab.onclick = () => {
                        currentCategory = category.category;
                        loadMenuCards(data, currentCategory);
                        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                        tab.classList.add('active');
            
                    };
                    categoryTabs.appendChild(tab);
                });
                document.querySelector('.tab').classList.add('active');
            }
        }
  
        // Load menu cards for a category
        function loadMenuCards(data, category) {
            const menuCards = document.getElementById('menuCards');
            if (menuCards) {
                menuCards.innerHTML = '';
                const selectedCategory = data.find(cat => cat.category === category);
                selectedCategory.dishes.forEach(dish => {
                    menuCards.appendChild(createMenuCard(dish));
                });
                menuCards.scrollLeft = 0; 
            }
        }

function createMenuCard(dish) {
    const cardLink = document.createElement('a');
    cardLink.href = `detailedmenu.html?name=${encodeURIComponent(dish.name)}&image=${encodeURIComponent(dish.image)}&tags=${encodeURIComponent(dish.tags.join(','))}&allergens=${encodeURIComponent(dish.allergens.join(','))}&description=${encodeURIComponent(dish.description)}&price=${dish.price}&restaurantId=${sessionStorage.getItem('restaurantId')}`;
    cardLink.className = 'card-link';

    const card = document.createElement('div');
    card.className = 'card';

    const image = new Image();
    image.src = dish.image; // Image src is set after preloading
    image.alt = dish.name;
    image.className = 'dish-image';

    const name = document.createElement('h3');
    name.className = 'dish-name';
    name.textContent = dish.name;

    const tags = document.createElement('div');
    tags.className = 'tags';
    dish.tags.forEach(tag => {
        const tagElement = document.createElement('span');
        tagElement.className = `tag ${tag.toLowerCase()}`;
        tagElement.textContent = tag;
        tags.appendChild(tagElement);
    });

    cardLink.appendChild(image);
    cardLink.appendChild(name);
    cardLink.appendChild(tags);

    card.appendChild(cardLink);

    // Conditionally add allergens below tags if they exist
    if (dish.allergens && dish.allergens.length > 0) {
        const allergens = document.createElement('p');
        allergens.className = 'allergens';
        allergens.textContent = `ALLERGENS: ${dish.allergens.join(', ')}`;
        card.appendChild(allergens); // Append allergens to the card, not the link
    }

    let optionsContainer = null; // Declare optionsContainer as null initially

    // Add options as buttons below allergens if available
    if (dish.options && dish.options.length > 0) {
        optionsContainer = document.createElement('div');
        optionsContainer.className = 'options-container';

        dish.options.forEach((option) => {
            const optionButton = document.createElement('button');
            optionButton.className = 'option-button';
            optionButton.textContent = option.isDiscount
                ? `${option.name} (10% Off)`
                : `${option.name} (+RM ${Number(option.priceIncrement).toFixed(2)})`;

            // Store additional data attributes for checking requirements
            optionButton.dataset.priceIncrement = Number(option.priceIncrement) || 0;
            optionButton.dataset.multiple = option.multiple;
            optionButton.dataset.isDiscount = option.isDiscount || false;
            optionButton.dataset.required = option.required || false; // New required flag
            optionButton.dataset.group = option.group || ''; // New group property

            optionButton.onclick = (event) => {
                event.stopPropagation(); // Prevent card click event

                if (option.multiple === true) {
                    // Allow multiple selections
                    optionButton.classList.toggle('selected');
                } else {
                    // Allow only one option to be selected at a time
                    optionsContainer.querySelectorAll('.option-button').forEach(btn => {
                        if (btn !== optionButton && btn.dataset.group === optionButton.dataset.group) {
                            btn.classList.remove('selected'); // Deselect other options in the same group
                        }
                    });
                    optionButton.classList.toggle('selected'); // Toggle the selected state
                }

                // Calculate total price with selected options and apply discount if needed
                calculateFinalPrice(dish, optionsContainer, card);
                // Check if required options are selected to enable the Add to Cart button
                toggleAddToCartButton(card, optionsContainer);
            };

            optionsContainer.appendChild(optionButton);
        });

        card.appendChild(optionsContainer); // Append options after allergens
    }

    const priceAdd = document.createElement('div');
    priceAdd.className = 'price-add';

    const price = document.createElement('span');
    price.className = 'price';
    price.textContent = `RM ${Number(dish.price).toFixed(2)}`; // Ensure number format

    const addToCart = document.createElement('button');
    addToCart.className = 'add-to-cart';
    addToCart.textContent = 'Add to cart';
    addToCart.disabled = true; // Initially disabled for dishes with required options

    // Warning message for required options
    const warningMessage = document.createElement('p');
    warningMessage.className = 'warning-message';
    warningMessage.style.display = 'none'; // Hide by default
    warningMessage.textContent = 'Please select required options to add to cart.';
    card.appendChild(warningMessage);

    // Prevent link navigation on add-to-cart button click
    addToCart.onclick = (event) => {
        event.preventDefault(); // Prevent the link from navigating

        // Capture all selected options
        const selectedOptions = Array.from(card.querySelectorAll('.option-button.selected')).map(btn => ({
            name: btn.textContent,
            priceIncrement: parseFloat(btn.dataset.priceIncrement || 0),
            isDiscount: btn.dataset.isDiscount === 'true'
        }));

        addToCartHandler(dish, selectedOptions);
    };

    priceAdd.appendChild(price);
    priceAdd.appendChild(addToCart);

    card.appendChild(priceAdd);

    // Enable the Add to Cart button if there are no required options or they are satisfied
    if (!optionsContainer || checkRequiredOptions(optionsContainer)) {
        addToCart.disabled = false; // Enable the button if there are no required options
    } else {
        toggleAddToCartButton(card, optionsContainer); // Check options initially
    }

    return card;
}


function addToCartHandler(dish, selectedOptions) {
    // Calculate total price increment from selected options
    let totalPriceIncrement = 0;
    let isDiscountApplied = false;

    selectedOptions.forEach(option => {
        if (option.isDiscount) {
            isDiscountApplied = true;
        } else {
            totalPriceIncrement += Number(option.priceIncrement) || 0; // Ensure number format
        }
    });

    // Calculate the final price with increments
    let finalPrice = Number(dish.price) + totalPriceIncrement;

    // Apply the discount if applicable
    if (isDiscountApplied) {
        finalPrice *= 0.90; // Apply 10% discount
    }

    const dishWithOptions = {
        ...dish,
        selectedOptions: selectedOptions.map(option => ({
            ...option,
            name: option.name.replace(/ \(\d+% Off\)$/, '')
        })), // Ensure clean option names
        price: Number(finalPrice).toFixed(2) // Set the final price after discounts and increments
    };

    cart.push(dishWithOptions);
    console.log('Cart:', cart);
    
    // Save cart to sessionStorage
    sessionStorage.setItem('cart', JSON.stringify(cart));
    updateCartButton(); // Update the cart button immediately after an item is added
}
        // Update the "Proceed to Order" button
        function updateCartButton() {
            const proceedToOrderButton = document.getElementById('proceedToOrderButton');
            const cartCount = document.querySelector('.cart-count');

            cartCount.textContent = cart.length;

            if (cart.length > 0) {
                proceedToOrderButton.disabled = false;
                proceedToOrderButton.classList.remove('disabled');
            } else {
                proceedToOrderButton.disabled = true;
                proceedToOrderButton.classList.add('disabled');
            }
        }

        
function toggleAddToCartButton(card, optionsContainer) {
    const addToCart = card.querySelector('.add-to-cart');
    const warningMessage = card.querySelector('.warning-message');

    if (!optionsContainer || checkRequiredOptions(optionsContainer)) {
        addToCart.disabled = false;
        addToCart.classList.add('enabled');
        addToCart.classList.remove('disabled');
        warningMessage.style.display = 'none'; // Hide warning message
    } else {
        addToCart.disabled = true;
        addToCart.classList.remove('enabled');
        addToCart.classList.add('disabled');
        warningMessage.style.display = 'block'; // Show warning message
    }
}
function calculateFinalPrice(dish, optionsContainer, card) {
    const selectedOptions = optionsContainer.querySelectorAll('.option-button.selected');
    let totalIncrement = 0;
    let isDiscountApplied = false;

    selectedOptions.forEach(btn => {
        if (btn.dataset.isDiscount === 'true') {
            isDiscountApplied = true;
        } else {
            totalIncrement += parseFloat(btn.dataset.priceIncrement || 0);
        }
    });

    // Calculate the final price including any increments
    let finalPrice = Number(dish.price) + totalIncrement;

    // Apply the discount after adding all increments
    if (isDiscountApplied) {
        finalPrice *= 0.90; // Apply 10% discount
    }

    updatePrice(finalPrice, card);
}

function updatePrice(finalPrice, card) {
    const priceElement = card.querySelector('.price');
    priceElement.textContent = `RM ${Number(finalPrice).toFixed(2)}`; // Ensure number formatting
}
        // Proceed to order page
        function proceedToOrder() {
            const tableNumber = sessionStorage.getItem('tableNumber') || '';
            sessionStorage.setItem('cart', JSON.stringify(cart));
            window.location.href = `ordersummary.html?table=${encodeURIComponent(tableNumber)}&restaurantId=${sessionStorage.getItem('restaurantId')}`;
        }

function checkRequiredOptions(optionsContainer) {
    if (!optionsContainer) {
        return true; // If no options, no requirements, so return true
    }

    const requiredOptions = optionsContainer.querySelectorAll('.option-button[data-required="true"]');
    const selectedRequiredOptions = Array.from(requiredOptions).filter(option => option.classList.contains('selected'));

    // Get all unique groups for required options
    const optionGroups = [...new Set(Array.from(requiredOptions).map(option => option.dataset.group))];
    
    // Ensure that every required group has at least one selected option
    const allGroupsSatisfied = optionGroups.every(group => {
        return selectedRequiredOptions.some(option => option.dataset.group === group);
    });

    return allGroupsSatisfied;
}


// Utility function to preload an image
function preloadImage(url) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.src = url;
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error(`Failed to load image: ${url}`));
    });
}

// Preload multiple images and return a Promise that resolves when all are loaded
function preloadImages(imageUrls) {
    return Promise.all(imageUrls.map(url => preloadImage(url)));
}
    </script>
</body>
</html>
